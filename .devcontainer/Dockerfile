# ä½¿ç”¨å®˜æ–¹ Node.js 24 é•œåƒä½œä¸ºåŸºç¡€
# ä½¿ç”¨æ ‡å‡†ç‰ˆæœ¬ï¼ˆåŒ…å«æ›´å¤šå·¥å…·ï¼‰ä»¥ä¾¿å®‰è£… Chromium
ARG NODE_VERSION=24
FROM node:${NODE_VERSION}-bookworm

# é¿å…äº¤äº’å¼æç¤º
ENV DEBIAN_FRONTEND=noninteractive

# æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
# ä½¿ç”¨å•ä¸ª RUN å‘½ä»¤å‡å°‘å±‚æ•°ï¼ŒåŠ é€Ÿæ„å»º
RUN apt-get update && apt-get install -y --no-install-recommends \
    # åŸºç¡€å·¥å…·
    git \
    curl \
    wget \
    ca-certificates \
    # SQLite3 å’Œå¼€å‘åº“
    sqlite3 \
    libsqlite3-dev \
    # å®‰è£… Chromiumï¼ˆDebian æä¾› ARM64 ç‰ˆæœ¬ï¼‰
    chromium \
    chromium-driver \
    # Puppeteer å’Œ Chrome ä¾èµ–
    fonts-liberation \
    libappindicator3-1 \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libcups2 \
    libdbus-1-3 \
    libdrm2 \
    libgbm1 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libx11-xcb1 \
    libxcb-dri3-0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libxss1 \
    libxtst6 \
    xdg-utils \
    # é¢å¤–çš„æµè§ˆå™¨ä¾èµ–
    libu2f-udev \
    libvulkan1 \
    # ä¸­æ–‡å­—ä½“æ”¯æŒï¼ˆå°çº¢ä¹¦å†…å®¹ç›¸å…³ï¼‰
    fonts-noto-cjk \
    fonts-noto-cjk-extra \
    fonts-wqy-zenhei \
    fonts-wqy-microhei \
    # æ¸…ç†
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®æ—¶åŒºä¸ºå¤ªå¹³æ´‹æ—¶é—´ï¼ˆæ¹¾åŒºï¼‰
ENV TZ=America/Los_Angeles
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# åˆ›å»ºé root ç”¨æˆ·ï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰
ARG USERNAME=node
ARG USER_UID=1000
ARG USER_GID=$USER_UID

# ç¡®ä¿ node ç”¨æˆ·å­˜åœ¨ï¼ˆåŸºç¡€é•œåƒå·²åˆ›å»ºï¼‰
RUN groupmod --gid $USER_GID $USERNAME \
    && usermod --uid $USER_UID --gid $USER_GID $USERNAME \
    && chown -R $USER_UID:$USER_GID /home/$USERNAME

# ç»™ node ç”¨æˆ· sudo æƒé™ï¼ˆDev Container éœ€è¦ï¼‰
RUN apt-get update && apt-get install -y sudo \
    && echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/$USERNAME \
    && chmod 0440 /etc/sudoers.d/$USERNAME \
    && rm -rf /var/lib/apt/lists/*

# é…ç½® npm å…¨å±€å®‰è£…è·¯å¾„ï¼ˆé¿å…æƒé™é—®é¢˜ï¼‰
RUN mkdir -p /home/$USERNAME/.npm-global \
    && chown -R $USERNAME:$USERNAME /home/$USERNAME/.npm-global

ENV NPM_CONFIG_PREFIX=/home/$USERNAME/.npm-global
ENV PATH=/home/$USERNAME/.npm-global/bin:$PATH

# å®‰è£…å¸¸ç”¨çš„å…¨å±€ npm åŒ…
RUN npm install -g \
    npm@latest \
    nodemon \
    pm2 \
    typescript

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /workspace

# ä¸º Puppeteer è®¾ç½®ç¯å¢ƒå˜é‡
# è·³è¿‡ä¸‹è½½ Chromeï¼Œä½¿ç”¨ç³»ç»Ÿçš„ Chromium
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium

# ğŸš€ Sculptor ä¼˜åŒ–è¯´æ˜ï¼š
# ä½¿ç”¨ç³»ç»Ÿçš„ Chromium è€Œä¸æ˜¯ Puppeteer ä¸‹è½½çš„ Chrome
# è¿™æ ·å¯ä»¥åœ¨ ARM64 ç³»ç»Ÿä¸Šæ­£å¸¸å·¥ä½œ

# åˆ‡æ¢åˆ° node ç”¨æˆ·ï¼ˆåœ¨å®‰è£… Chrome ä¹‹å‰åˆ‡æ¢ï¼‰
USER $USERNAME

# è®¾ç½® Puppeteer ç¼“å­˜è·¯å¾„ä¸º node ç”¨æˆ·çš„ home ç›®å½•
ENV PUPPETEER_CACHE_DIR=/home/$USERNAME/.cache/puppeteer

# æ³¨æ„ï¼šChrome ä¼šåœ¨ post-create.sh ä¸­å®‰è£…ï¼ˆæœ‰ç½‘ç»œä¿è¯ï¼‰
# è¿™é‡Œä¸é¢„è£…æ˜¯ä¸ºäº†é¿å…æ„å»ºæ—¶çš„ç½‘ç»œé—®é¢˜

# è®¾ç½® shell ä¸º bash
ENV SHELL=/bin/bash

# å¥åº·æ£€æŸ¥ï¼ˆç¡®ä¿ Node.js å¯ç”¨ï¼‰
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD node --version || exit 1

# é»˜è®¤å‘½ä»¤
CMD ["/bin/bash"]
